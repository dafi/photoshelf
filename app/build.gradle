apply plugin: 'com.android.application'

dependencies {
    compile fileTree(dir: 'libs', include: '*.jar')
    // Copy dropbox native libraries as described at
    // https://www.dropbox.com/developers/blog/57/using-the-sync-api-with-android-studio
    compile files('libs/dropbox-sync-sdk-android.jar')
    compile files("$buildDir/native-libs/native-libs.jar")

    compile "com.android.support:appcompat-v7:21.0.3"

    compile "org.scribe:scribe:1.3.5"
    compile "org.jsoup:jsoup:1.7.3"

    compile "com.ternaryop:utils:1.0"

    testCompile 'junit:junit:4.12'
    testCompile "org.mockito:mockito-core:1.9.5"
}

android {
    compileSdkVersion 21
    buildToolsVersion "21.1.2"

    defaultConfig {
        applicationId "com.ternaryop.photoshelf"
        minSdkVersion 18
        targetSdkVersion 21
        versionCode versionCodeByTask()
    }

    signingConfigs {
        release {
            def props = new Properties()
            props.load(new FileInputStream("$rootDir/app/build-keystore.properties"))
            storeFile file(props.get("key.store"))
            storePassword props.get("key.store.password")
            keyAlias props.get("key.alias")
            keyPassword props.get("key.alias.password")
        }
    }
    lintOptions {
        abortOnError false
    }
    buildTypes {
        release {
            signingConfig signingConfigs.release
        }
        debug {
            applicationIdSuffix ".debug"
        }
    }

    // Workaround for "Method ... not mocked." in test cases
    testOptions {
        unitTests.returnDefaultValues = true
    }
}

task nativeLibsToJar(type: Zip) {
    destinationDir file("$buildDir/native-libs")
    baseName 'native-libs'
    extension 'jar'
    from fileTree(dir: 'libs', include: '**/*.so')
    into 'lib/'
}

tasks.withType(JavaCompile) {
    compileTask -> compileTask.dependsOn(nativeLibsToJar)
    options.compilerArgs << "-Xlint:unchecked" << "-Xlint:deprecation"
}

def versionCodeByTask() {
    def props = new Properties()
    def versionFile = new File("$rootDir/app/version.properties")
    def versionCode = 0;
    if (versionFile.exists()) {
        props.load(new FileReader(versionFile))
        versionCode = props["versionCode"]?.isInteger() ? props["versionCode"].toInteger() : 0
    }

    // Increment the versionCode only for specific tasks (eg the assemble release tasks)
    def runTasks = gradle.startParameter.taskNames
    def incrementableTaskNames = ["aR", "assembleRelease"]
    if (incrementableTaskNames.find {name -> name in runTasks}) {
        ++versionCode
        props["versionCode"] = versionCode.toString()
        props.store(new FileWriter(versionFile), null)
    }
    return versionCode;
}